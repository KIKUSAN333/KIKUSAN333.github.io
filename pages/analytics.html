<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>分析画面 - 日報システム</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="nav-brand"><h1>日報システム - 分析画面</h1></div>
            <ul class="nav-menu">
                <li><a href="reports.html">日報一覧</a></li>
                <li><a href="login.html">ログアウト</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="container">
            <h2 class="section-title">分析ダッシュボード</h2>

            <div class="filters" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                <select id="filter-store">
                    <option value="">全店舗</option>
                </select>
                <input type="date" id="from-date">〜
                <input type="date" id="to-date">
                <button id="apply-filters" class="secondary-button">適用</button>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                <div class="card">
                    <h3>店舗別スコア（期間別）</h3>
                    <canvas id="score-chart" height="200"></canvas>
                </div>
                <div class="card">
                    <h3>カテゴリ内訳（クレーム・賛辞・売上）</h3>
                    <canvas id="category-chart" height="200"></canvas>
                </div>
                <div class="card" style="grid-column:1 / -1;">
                    <h3>総合評価・目標スコア比較</h3>
                    <canvas id="goal-chart" height="120"></canvas>
                </div>

                <div class="card">
                    <h3>店舗ランキング（売上）</h3>
                    <div id="ranking-list"></div>
                </div>

                <div class="card">
                    <h3>PDCA</h3>
                    <div class="pdc-tabs" style="display:flex;gap:8px;margin-bottom:8px;">
                        <button class="secondary-button pdc-btn active" data-step="Plan">Plan</button>
                        <button class="secondary-button pdc-btn" data-step="Do">Do</button>
                        <button class="secondary-button pdc-btn" data-step="Check">Check</button>
                        <button class="secondary-button pdc-btn" data-step="Action">Action</button>
                    </div>
                    <div id="pdc-content">
                        <p>Plan: 目標設定や改善案をここにメモできます（デモ）</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container"><p>&copy; 2025 日報システム</p></div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', ()=>{
            // basic auth check (session)
            try {
                const user = JSON.parse(sessionStorage.getItem('dailyUser'));
                if (!user || !user.id) {
                    window.location.href = 'login.html';
                    return;
                }
            } catch(e){ window.location.href = 'login.html'; return; }

            // Prefer raw loader so negative scores (historical) are shown in analytics
            function loadReports(){ return (window.DailyCommon && typeof window.DailyCommon.loadRawReports === 'function') ? window.DailyCommon.loadRawReports() : (window.DailyCommon && typeof window.DailyCommon.loadReports === 'function' ? window.DailyCommon.loadReports() : JSON.parse(localStorage.getItem('dailyReports')||'[]')); }
            function getStores(reports){ const s={}; (reports||[]).forEach(r=>{ if (r && r.store) s[r.store]=true }); return Object.keys(s).sort(); }

            // simple aggregation helpers
            function aggregateByStore(reports, from, to){
                const byStore = {};
                reports.forEach(r=>{
                    const d = new Date(r.date);
                    if (from && d < from) return;
                    if (to && d > to) return;
                    const store = r.store || '未設定';
                    if (!byStore[store]) byStore[store] = { count:0, sales:0, scoreSum:0 };
                    byStore[store].count += 1;
                    byStore[store].sales += Number(r.sales || 0);
                    byStore[store].scoreSum += Number(r.score || 0);
                });
                return byStore;
            }

            function buildCharts(reports){
                const from = document.getElementById('from-date').value ? new Date(document.getElementById('from-date').value) : null;
                const to = document.getElementById('to-date').value ? new Date(document.getElementById('to-date').value) : null;
                const storeFilter = document.getElementById('filter-store').value;
                const filtered = reports.filter(r=>{
                    if (storeFilter && r.store !== storeFilter) return false;
                    const d = new Date(r.date);
                    if (from && d < from) return false;
                    if (to && d > to) return false;
                    return true;
                });

                const byStore = aggregateByStore(filtered, from, to);
                const labels = Object.keys(byStore);
                const avgScores = labels.map(s => byStore[s].count ? (byStore[s].scoreSum / byStore[s].count).toFixed(2) : 0);
                const sales = labels.map(s => byStore[s].sales);

                // score chart
                if (window._scoreChart) window._scoreChart.destroy();
                const scoreEl = document.getElementById('score-chart');
                if (scoreEl) {
                    const ctx = scoreEl.getContext('2d');
                    window._scoreChart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{label:'平均スコア', data:avgScores, backgroundColor:'#4CAF50'},{label:'売上', data:sales, backgroundColor:'#2196F3'}] }, options:{responsive:true, scales:{y:{beginAtZero:true}}} });
                }

                // category breakdown
                const cat = { claim:0, praise:0, sales:0, other:0 };
                filtered.forEach(r=>{
                    const text = (r.memo||'') + ' ' + (r.type||'');
                    const t = String(text).toLowerCase();
                    if (t.includes('クレーム') || t.includes('complaint')) cat.claim++;
                    else if (t.includes('賛辞') || t.includes('褒め') || t.includes('praise')) cat.praise++;
                    else if ((Number(r.sales)||0) > 0) cat.sales++;
                    else cat.other++;
                });
                const catEl = document.getElementById('category-chart');
                if (catEl) {
                    if (window._catChart) window._catChart.destroy();
                    const ctx2 = catEl.getContext('2d');
                    window._catChart = new Chart(ctx2, { type:'doughnut', data:{ labels:['クレーム','賛辞','売上','その他'], datasets:[{data:[cat.claim,cat.praise,cat.sales,cat.other], backgroundColor:['#f44336','#ff9800','#2196f3','#9e9e9e']}] }, options:{responsive:true} });
                }

                // goal comparison
                const overallScores = filtered.map(r=>Number(r.score||0)).filter(v=>v>0);
                const avgOverall = overallScores.length ? (overallScores.reduce((a,b)=>a+b,0)/overallScores.length) : 0;
                const target = Number(localStorage.getItem('targetScore')||80);
                const goalEl = document.getElementById('goal-chart');
                if (goalEl) {
                    if (window._goalChart) window._goalChart.destroy();
                    const ctx3 = goalEl.getContext('2d');
                    window._goalChart = new Chart(ctx3, { type:'bar', data:{ labels:['平均スコア','目標スコア'], datasets:[{label:'スコア', data:[avgOverall.toFixed(2), target], backgroundColor:['#673ab7','#ffc107']}] }, options:{indexAxis:'y', responsive:true, scales:{x:{beginAtZero:true}}} });
                }

                // ranking by sales
                const ranking = Object.entries(byStore).map(([k,v])=>({store:k, sales:v.sales})).sort((a,b)=>b.sales-a.sales);
                const list = document.getElementById('ranking-list');
                if (list) {
                    if (ranking.length===0) list.innerHTML = '<p>データがありません</p>';
                    else list.innerHTML = '<ol>' + ranking.map(r=>`<li><strong>${r.store}</strong> - 売上: ${r.sales}</li>`).join('') + '</ol>';
                }
            }

            function populateFilters(){
                const reports = loadReports();
                const stores = getStores(reports);
                const sel = document.getElementById('filter-store');
                if (sel) sel.innerHTML = '<option value="">全店舗</option>' + stores.map(s=>`<option value="${s}">${s}</option>`).join('');
            }

            const applyBtn = document.getElementById('apply-filters');
            if (applyBtn) applyBtn.addEventListener('click', ()=>{ buildCharts(loadReports()); });

            // PDCA tabs
            document.querySelectorAll('.pdc-btn').forEach(b=> b.addEventListener('click', (e)=>{ document.querySelectorAll('.pdc-btn').forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active'); const step = e.currentTarget.dataset.step; const content = document.getElementById('pdc-content'); if (content) content.innerHTML = `<p>${step}: （ここに${step}内容を記入）</p>`;}));

            // init
            populateFilters(); buildCharts(loadReports());
        });
    </script>
</body>
</html>
